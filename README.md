# Subscription Billing Service API

## Описание проекта

Этот проект представляет собой REST API для биллингового сервиса, который позволяет управлять подписками, тарифными планами, счетами, платежами, польлователями и их ролями. Также в него интегрирован YooKassa API с возможностью тестовой оплаты.  API поддерживает авторизацию через JWT и реализует мультиарендность.

### Основной функционал

Сервис реализует возможость пользователям оформлять подписки по различным тарифным планам, которые могут различаться по стоимости, сроку подписки и стоимости. Владелец подписки может управлять ей - добавлять в неё пользователей, устанавливать им роли и снимать их.

После создания подписки, она принимает статус INACTIVE, создаётся счёт на оплату подписки со статусом AWAITING_PAYMENT. После этого владелец или администраторы подписки могут создать платёж к счёту со способами оплаты YOO_MONEY или BANK_CARD. После создания платежа, он получает статус PENDING, ответ будет содерджать ссылку на оплату в YooKassa. 

Scheduler каждые 10 секунд проверяет подписки, пока статус не поменяется на SUCCEEDED или CANCELLED. В случае неуспешной оплаты ничего не произойдет, в случа успешной - счёт получит статус PAYED и подписка активируется - ей присвоится дата начала и окончания, в зависимости от BillingCycle тарифного плана (DAILY, WEEKLY, MONTHLY, YEARLY) и она получит статус ACTIVE.

Другой Scheduler каждый день в 00:00 проверяет подписки на истечение срока. Если срок истекает - подписке устанавливается статус PAUSED и создаётся счёт на оплату. Если через 24 часа при следующей проверке подписка не будет оплачена, то она перейдёт в статус INACTIVE до того, как будет произведён успешный платёж.

### Иерархия ролей

1. **SUPER-ADMIN**
    - Администратор сервиса - может добавлять, изменять и удалять тарифные планы.

2. **OWNER**
    - Полный доступ к управлению своей подпиской (обновление, удаление, приостановка).
    - Может выдавать и убирать роль ADMIN у пользователей внутри своей подписки.

3. **ADMIN**
    - Полный доступ ко всем операциям с счетами и платежами в подписке.
    - Может создавать, обновлять и удалять пользователей внутри своей подписки.

4. **USER**
    - Ограниченный доступ.
    - Может просматривать свою информацию или информацию пользователей в своей подписке.
    - Может просматривать информацию о тарифных планах.
    - Может изменять данные своей учетной записи.

## Стек технологий

- Java 21
- Spring Boot 3
- PostgreSQL
- Hibernate
- Swagger
- Docker
- Apache Kafka
- Apache Maven
- REST
- JWT
- Saas multitenancy
- CORS
- YooKassa API

## Установка
### Шаги для установки

1. Клонируйте репозиторий:

   ```bash
   git clone https://github.com/codbid/subscription-billing-service.git

2. Перейдите в директорию проекта:

   ```bash
   cd subscription-billing-service

3. Запустите контейнеры:

   ```bash
   docker-compose up
   
## Документация API
### Swagger

После запуска по адресу http://localhost:8080/swagger-ui/index.html будет доступен Swagger.
Необходимо авторизоваться с логином и паролем admin:admin.

В Swagger эндпоинты для удобства сгруппированы по тегам сущностей и тегам ролей.
